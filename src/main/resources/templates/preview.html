<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Результат расчёта — Обогреваемое стекло</title>

    <style>
        :root{
            --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280;
            --border:#e5e7eb; --blue:#2563eb; --blue2:#1d4ed8;
            --green:#16a34a; --red:#dc2626; --amber:#d97706;
        }
        *{box-sizing:border-box;}
        body{
            margin:0;
            font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            background:var(--bg);
            color:var(--text);
        }
        .wrap{max-width:1200px;margin:26px auto;padding:0 16px;}
        .header{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;margin-bottom:16px;flex-wrap:wrap;}
        h1{margin:0;font-size:22px;}
        .sub{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.3;}
        .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
        .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;}
        @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

        .card{
            background:var(--card);
            border:1px solid var(--border);
            border-radius:16px;
            box-shadow:0 10px 24px rgba(17,24,39,.05);
            overflow:hidden;
        }
        .card-h{
            padding:14px 16px;
            border-bottom:1px solid var(--border);
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            flex-wrap:wrap;
        }
        .card-h .title{font-weight:900;}
        .card-b{padding:16px;}

        .badge{
            font-size:12px;
            padding:6px 10px;
            border-radius:999px;
            border:1px solid var(--border);
            background:#fafafa;
            white-space:nowrap;
            font-weight:700;
        }
        .badge.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46;}
        .badge.warn{background:#fffbeb;border-color:#fde68a;color:#92400e;}
        .badge.bad{background:#fef2f2;border-color:#fecaca;color:#991b1b;}

        .btn{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            padding:10px 12px;
            border-radius:12px;
            border:1px solid var(--border);
            text-decoration:none;
            color:var(--text);
            background:#fff;
            font-weight:800;
            font-size:14px;
            transition:.15s ease-in-out;
        }
        .btn:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(17,24,39,.08);}
        .btn.primary{background:var(--blue);color:#fff;border-color:var(--blue);}
        .btn.primary:hover{background:var(--blue2);border-color:var(--blue2);}
        .btn.green{background:var(--green);color:#fff;border-color:var(--green);}
        .btn.ghost{background:#fff;}
        .btn.red{background:var(--red);color:#fff;border-color:var(--red);}

        .muted{color:var(--muted);font-size:13px;line-height:1.35;}
        .small{font-size:12px;color:var(--muted);}
        .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;}

        .kpi{
            display:grid;
            grid-template-columns:repeat(2,1fr);
            gap:10px;
        }
        @media (max-width: 520px){ .kpi{grid-template-columns:1fr;} }
        .k{
            border:1px solid var(--border);
            border-radius:14px;
            padding:12px;
            background:#fff;
        }
        .k .t{color:var(--muted);font-size:12px;margin-bottom:6px;font-weight:800;text-transform:uppercase;letter-spacing:.02em;}
        .k .v{font-size:18px;font-weight:900;}
        .k .u{color:var(--muted);font-size:12px;margin-top:5px;}

        table{width:100%;border-collapse:collapse;}
        th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top;}
        th{text-align:left;color:var(--muted);font-weight:900;font-size:12px;text-transform:uppercase;letter-spacing:.02em;}
        td{font-size:14px;}

        .previewBox{
            margin-top:12px;
            border:1px solid var(--border);
            border-radius:14px;
            overflow:hidden;
            background:#fff;
        }
        .previewHead{
            display:flex;align-items:center;justify-content:space-between;gap:10px;
            padding:10px 12px;border-bottom:1px solid var(--border);
            background:#fafafa;
            font-weight:900;
        }
        .svgContainer{
            height:520px;
            overflow:auto;
            background:#ffffff;
        }
        .svgContainer svg{display:block;margin:0 auto;min-height:520px;width:100%;}
        @media (max-width: 768px){
            .svgContainer{height:420px;}
        }

        .err{
            background:#fef2f2;
            border:1px solid #fecaca;
            color:#991b1b;
            padding:12px;
            border-radius:14px;
            font-weight:700;
            margin-bottom:14px;
        }
    </style>
</head>

<body>
<div class="wrap">

    <div class="header">
        <div>
            <h1>Результат расчёта</h1>
            <div class="sub" th:if="${result != null}">
                Рисунок: <b th:text="${result.patternType == 2 ? 'Соты' : 'Зигзаг'}">Соты</b>,
                ориентация шин: <b th:text="${result.busbarOrientation == 1 ? 'сверху/снизу' : 'слева/справа'}">сверху/снизу</b>
            </div>
            <div class="sub" th:if="${result == null}">
                Выполните расчёт, чтобы увидеть результат.
            </div>
        </div>

        <div class="row" th:if="${result != null}">
            <span class="badge"
                  th:classappend="${T(java.lang.Math).abs(result.powerDeviationPercent) <= 3 ? ' ok' : (T(java.lang.Math).abs(result.powerDeviationPercent) <= 10 ? ' warn' : ' bad')}"
                  th:text="${'Отклонение: ' + #numbers.formatDecimal(result.powerDeviationPercent, 1, 1) + ' %'}">
                Отклонение: 0.0 %
            </span>

            <a class="btn ghost" th:href="@{/}">← Новый расчёт</a>
        </div>
    </div>

    <div th:if="${error != null}" class="err" th:text="${error}">
        Ошибка
    </div>

    <div th:if="${result != null}" class="grid">

        <!-- ЛЕВО: KPI + кнопки -->
        <div class="card">
            <div class="card-h">
                <div class="title">Ключевые показатели</div>
                <div class="row">
                    <a class="btn primary" th:href="@{/preview}">Перейти к предпросмотру</a>
                    <a class="btn" th:href="@{/export/svg}">Скачать SVG</a>
                    <a class="btn" th:href="@{/export/dxf}">Скачать DXF</a>
                    <a class="btn green" th:href="@{/export/pdf}">Скачать PDF</a>
                </div>
            </div>

            <div class="card-b">
                <div class="kpi">
                    <div class="k">
                        <div class="t">Цель (удельная мощность)</div>
                        <div class="v" th:text="${#numbers.formatDecimal(result.targetPower,1,0)} + ' Вт/м²'">200 Вт/м²</div>
                        <div class="u">то, что вы задали</div>
                    </div>
                    <div class="k">
                        <div class="t">Факт (удельная мощность)</div>
                        <div class="v" th:text="${#numbers.formatDecimal(result.achievedPowerWm2,1,1)} + ' Вт/м²'">205.2 Вт/м²</div>
                        <div class="u">что получится по текущей модели</div>
                    </div>

                    <div class="k">
                        <div class="t">R_target (нужно)</div>
                        <div class="v" th:text="${#numbers.formatDecimal(result.totalResistance,1,2)} + ' Ω'">562.14 Ω</div>
                        <div class="u">целевое сопротивление между шинами</div>
                    </div>
                    <div class="k">
                        <div class="t">R_achieved (достигнуто)</div>
                        <div class="v" th:text="${#numbers.formatDecimal(result.achievedResistance,1,2)} + ' Ω'">547.88 Ω</div>
                        <div class="u">расчётное сопротивление (факт)</div>
                    </div>

                    <div class="k">
                        <div class="t">R_raw (без абляции)</div>
                        <div class="v" th:text="${#numbers.formatDecimal(result.rawResistance,1,2)} + ' Ω'">39.54 Ω</div>
                        <div class="u">если рисунка нет</div>
                    </div>
                    <div class="k">
                        <div class="t">Множитель</div>
                        <div class="v" th:text="${#numbers.formatDecimal(result.pathLengthMultiplier,1,3)} + ' ×'">13.858 ×</div>
                        <div class="u">насколько рисунок повышает сопротивление</div>
                    </div>
                </div>

                <div class="previewBox" th:if="${svg != null}">
                    <div class="previewHead">
                        <div>Предпросмотр (SVG)</div>
                        <div class="small">* Это быстрый просмотр, полный — на странице предпросмотра</div>
                    </div>
                    <div class="svgContainer">
                        <div th:utext="${svg}">SVG будет тут</div>
                    </div>
                </div>

                <div class="small" style="margin-top:10px;">
                    Экспорт/предпросмотр берутся из “последнего результата” в сессии:
                    <span class="mono">SESSION_LAST_RESULT</span>.
                </div>
            </div>
        </div>

        <!-- ПРАВО: параметры -->
        <div class="card">
            <div class="card-h">
                <div class="title">Параметры</div>
            </div>
            <div class="card-b">
                <table>
                    <tr>
                        <th>Размер стекла</th>
                        <td>
                            <b th:text="${#numbers.formatDecimal(result.width,1,0)}">700</b> ×
                            <b th:text="${#numbers.formatDecimal(result.height,1,0)}">615</b> мм
                        </td>
                    </tr>
                    <tr>
                        <th>Плоскостное сопротивление</th>
                        <td th:text="${#numbers.formatDecimal(result.sheetResistance,1,2)} + ' Ω/□'">45.00 Ω/□</td>
                    </tr>
                    <tr>
                        <th>Отступ от края</th>
                        <td th:text="${#numbers.formatDecimal(result.edgeOffset,1,1)} + ' мм'">12.0 мм</td>
                    </tr>
                    <tr>
                        <th>Ширина шины</th>
                        <td th:text="${#numbers.formatDecimal(result.busbarWidth,1,1)} + ' мм'">5.0 мм</td>
                    </tr>
                    <tr>
                        <th>Ориентация шин</th>
                        <td th:text="${result.busbarOrientation == 1 ? 'Сверху/снизу' : 'Слева/справа'}">Сверху/снизу</td>
                    </tr>

                    <tr th:if="${result.patternType == 2}">
                        <th>Сота: сторона a</th>
                        <td th:text="${#numbers.formatDecimal(result.hexSide,1,1)} + ' мм'">13.0 мм</td>
                    </tr>
                    <tr th:if="${result.patternType == 2}">
                        <th>Сота: зазор gap</th>
                        <td th:text="${#numbers.formatDecimal(result.hexGap,1,1)} + ' мм'">9.5 мм</td>
                    </tr>
                    <tr th:if="${result.patternType == 2}">
                        <th>Зазор до шины</th>
                        <td th:text="${result.busbarClearanceMm != null ? (#numbers.formatDecimal(result.busbarClearanceMm,1,1) + ' мм') : '—'}">—</td>
                    </tr>
                </table>

                <div class="muted" style="margin-top:12px;">
                    Если вы видите большие расхождения — это означает, что текущая геометрия/абляция
                    даёт слишком малое или слишком большое эквивалентное сопротивление между шинами.
                </div>
            </div>
        </div>

    </div>

</div>
<!-- Loading overlay (shows while long backend methods execute) -->
<div id="loadingOverlay" style="
  display:none; position:fixed; inset:0; background:rgba(255,255,255,0.75);
  z-index:9999; align-items:center; justify-content:center;">
    <div style="
      width:56px; height:56px; border:6px solid #ccc; border-top-color:#333;
      border-radius:50%; animation: spin 0.9s linear infinite;">
    </div>
</div>

<style>
  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<script>
  (function () {
    const overlay = document.getElementById('loadingOverlay');
    const show = () => { if (overlay) overlay.style.display = 'flex'; };
    const hide = () => { if (overlay) overlay.style.display = 'none'; };

    document.querySelectorAll('form').forEach(f => {
      f.addEventListener('submit', () => {
        show();
        f.querySelectorAll('button, input[type="submit"]').forEach(b => { b.disabled = true; });
      });
    });

    window.addEventListener('load', () => hide());
    window.addEventListener('pageshow', (e) => { if (e.persisted) hide(); });
  })();
</script>

</body>
</html>
