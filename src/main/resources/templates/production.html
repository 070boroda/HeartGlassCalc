<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Производственный режим</title>

    <style>
        body {
            font-family:'Segoe UI', Tahoma, sans-serif;
            background:linear-gradient(135deg,#667eea,#764ba2);
            padding:30px;
            min-height: 100vh;
        }

        .container {
            background:white;
            padding:30px;
            border-radius:20px;
            max-width:1200px;
            margin:auto;
            box-shadow:0 20px 60px rgba(0,0,0,0.3);
        }

        h1 { margin:0 0 8px 0; color:#222; }
        .sub { color:#666; margin-bottom: 16px; }

        .banner {
            padding:12px 14px;
            border-radius:12px;
            margin: 10px 0 16px 0;
            font-weight:800;
            line-height: 1.35;
        }
        .ok  { background:#e8f5e9; border:1px solid #c8e6c9; color:#1b5e20; }
        .bad { background:#ffebee; border:1px solid #ffcdd2; color:#b71c1c; }

        .meta {
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
            gap:12px;
            margin: 16px 0 10px 0;
        }
        .card {
            border:1px solid #e5e5e5;
            border-radius:14px;
            padding:14px;
            box-shadow:0 4px 14px rgba(0,0,0,0.06);
        }
        .label { font-size:12px; color:#666; text-transform:uppercase; letter-spacing:0.5px; }
        .value { font-size:22px; font-weight:900; margin-top:6px; color:#222; }
        .unit  { font-size:12px; color:#888; margin-top:4px; }

        table {
            width:100%;
            border-collapse:collapse;
            margin-top:16px;
            overflow:hidden;
            border-radius:14px;
            box-shadow:0 10px 24px rgba(0,0,0,0.10);
        }

        th, td {
            border:1px solid #eee;
            padding:10px;
            text-align:center;
            font-size: 14px;
        }

        th {
            background:#f6f7fb;
            font-weight:900;
            color:#333;
        }

        tr:nth-child(even) td { background:#fafafa; }

        .dev-good { color:#1b5e20; font-weight:900; }
        .dev-mid  { color:#E65100; font-weight:900; }
        .dev-bad  { color:#b71c1c; font-weight:900; }

        .btn {
            padding:8px 12px;
            border:none;
            border-radius:10px;
            font-weight:900;
            cursor:pointer;
            color:white;
            background: linear-gradient(135deg,#4CAF50,#2E7D32);
            box-shadow:0 8px 16px rgba(0,0,0,0.18);
        }
        .btn:hover { transform: translateY(-1px); }

        .back {
            margin-top:18px;
            display:inline-flex;
            gap:8px;
            align-items:center;
            padding:10px 14px;
            border-radius:10px;
            text-decoration:none;
            color:white;
            font-weight:900;
            background: linear-gradient(135deg,#607D8B,#37474F);
            box-shadow:0 8px 16px rgba(0,0,0,0.18);
        }

        .small { font-size:12px; color:#777; margin-top:10px; }

    </style>
</head>
<body>

<div class="container">

    <h1>Производственный режим (AUTO)</h1>
    <div class="sub">Подбор TOP-5 сочетаний (a / gap), близких к целевой мощности.</div>

    <div th:class="${prod.achievable} ? 'banner ok' : 'banner bad'">
        <span th:text="${prod.recommendation}"></span>
    </div>

    <div class="meta">
        <div class="card">
            <div class="label">Требуемый multiplier</div>
            <div class="value" th:text="${#numbers.formatDecimal(prod.requiredMultiplier,1,2)}"></div>
            <div class="unit">раз</div>
        </div>

        <div class="card">
            <div class="label">Максимальный multiplier (в диапазоне)</div>
            <div class="value" th:text="${#numbers.formatDecimal(prod.maxMultiplier,1,2)}"></div>
            <div class="unit">раз</div>
        </div>

        <div class="card">
            <div class="label">Максимально достижимая мощность</div>
            <div class="value" th:text="${#numbers.formatDecimal(prod.maxAchievablePowerWm2,1,1)}"></div>
            <div class="unit">Вт/м²</div>
        </div>

        <div class="card">
            <div class="label">Целевая мощность</div>
            <div class="value" th:text="${#numbers.formatDecimal(baseParams.targetPower,1,0)}"></div>
            <div class="unit">Вт/м²</div>
        </div>
    </div>

    <table>
        <thead>
        <tr>
            <th>a (мм)</th>
            <th>gap (мм)</th>
            <th>Multiplier</th>
            <th>Факт. мощность (Вт/м²)</th>
            <th>Отклонение (%)</th>
            <th>Применить → предпросмотр</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="d : ${prod.designs}">
            <td th:text="${#numbers.formatDecimal(d.hexSide,1,1)}"></td>
            <td th:text="${#numbers.formatDecimal(d.hexGap,1,1)}"></td>
            <td th:text="${#numbers.formatDecimal(d.multiplier,1,2)}"></td>
            <td th:text="${#numbers.formatDecimal(d.achievedPowerWm2,1,1)}"></td>

            <td th:with="absDev=${T(java.lang.Math).abs(d.deviationPercent)}"
                th:class="${absDev <= 5} ? 'dev-good' : (${absDev <= 10} ? 'dev-mid' : 'dev-bad')"
                th:text="${#numbers.formatDecimal(d.deviationPercent,1,1)}"></td>

            <td>
                <form method="post" action="/manual">
                    <input type="hidden" name="width" th:value="${baseParams.width}">
                    <input type="hidden" name="height" th:value="${baseParams.height}">
                    <input type="hidden" name="targetPower" th:value="${baseParams.targetPower}">
                    <input type="hidden" name="sheetResistance" th:value="${baseParams.sheetResistance}">
                    <input type="hidden" name="edgeOffset" th:value="${baseParams.edgeOffset}">
                    <input type="hidden" name="busbarWidth" th:value="${baseParams.busbarWidth}">
                    <input type="hidden" name="busbarOrientation" th:value="${baseParams.busbarOrientation}">
                    <input type="hidden" name="patternType" value="2">

                    <input type="hidden" name="hexSide" th:value="${d.hexSide}">
                    <input type="hidden" name="hexGap" th:value="${d.hexGap}">

                    <button type="submit" class="btn">Применить</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>

    <div class="small">
        Подсказка: зелёное — обычно хорошо (≤5%), жёлтое — допустимо (≤10%), красное — лучше изменить Rs/размеры или ограничения.
    </div>

    <a class="back" href="/">← Новый расчёт</a>

</div>

<!-- Loading overlay (shows while long backend methods execute) -->
<div id="loadingOverlay" style="
  display:none; position:fixed; inset:0; background:rgba(255,255,255,0.75);
  z-index:9999; align-items:center; justify-content:center;">
    <div style="
      width:56px; height:56px; border:6px solid #ccc; border-top-color:#333;
      border-radius:50%; animation: spin 0.9s linear infinite;">
    </div>
</div>

<style>
  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<script>
  (function () {
    const overlay = document.getElementById('loadingOverlay');
    const show = () => { if (overlay) overlay.style.display = 'flex'; };
    const hide = () => { if (overlay) overlay.style.display = 'none'; };

    document.querySelectorAll('form').forEach(f => {
      f.addEventListener('submit', () => {
        show();
        f.querySelectorAll('button, input[type="submit"]').forEach(b => { b.disabled = true; });
      });
    });

    window.addEventListener('load', () => hide());
    window.addEventListener('pageshow', (e) => { if (e.persisted) hide(); });
  })();
</script>

</body>
</html>
